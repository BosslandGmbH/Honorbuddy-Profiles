<HBProfile xsi:noNamespaceSchemaLocation="../Schemas/EchoSchema.xsd" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	<!-- Original contribution by EchoTiger -->
	<Name>[N-Quest] Legion Intro Quests [Echo]</Name>

	<MinDurability>0.3</MinDurability>
	<MinFreeBagSlots>3</MinFreeBagSlots>

	<SellGrey>true</SellGrey>
	<SellWhite>true</SellWhite>
	<SellGreen>true</SellGreen>
	<SellBlue>true</SellBlue>
	<SellPurple>false</SellPurple>

	<MailGrey>false</MailGrey>
	<MailWhite>true</MailWhite>
	<MailGreen>true</MailGreen>
	<MailBlue>true</MailBlue>
	<MailPurple>true</MailPurple>

	<TargetElites>true</TargetElites>

	<InitOrder>
		<!-- Perhaps add detection for loading the class hall if player hasn't unlocked this zone yet. -->
		<CustomBehavior File="Misc\RunLua" Lua="SetCVar('AutoLootDefault', 1)" />

		<CustomBehavior File="EnablePlugin" Names="Anti Drown" />
		<CustomBehavior File="EnablePlugin" Names="Refreshment Detection" />

		<CustomBehavior File="Misc\ProfileCompatibilityInfo" AllowBrokenAddOns="true" AllowBrokenPlugIns="true" />

		<LootMobs Value="true" />
		<TargetingDistance Value="45" /> <!-- Use LevelBot default -->
	</InitOrder>

	<QuestOrder> <!-- No checkpoints here. -->

		<!-- RunCode Methods -->
			<CustomBehavior File="RunCode" Type="Definition"><![CDATA[
					bool DoQuest(params uint[] questIds)
					{
						foreach (var questId in questIds)
						{
							if (HasQuest(questId) && !IsQuestCompleted(questId)) return true;
						}
						return false;
					}
					bool NeedsQuest(params uint[] questIds)
					{
						foreach (var questId in questIds)
						{
							if (!HasQuest(questId) && !IsQuestCompleted(questId)) return true;
						}
						return false;
					}
					bool NeedsBreadcrumbQuest(params uint[] questIds)
					{
						foreach (var questId in questIds)
						{
							if (IsQuestCompleted(questId)) return false;
						}
						return true;
					}
					bool QuestDone(params uint[] questIds)
					{
						foreach (var questId in questIds)
						{
							if (HasQuest(questId) && IsQuestCompleted(questId)) return true;
						}
						return false;
					}

					async Task SkipCutscene()
					{
				// Add detection of cutscene here.
						await Coroutine.Sleep(3000);
				// Test and improve the working method.
						Lua.DoString("MovieFrame:StopMovie(); CinematicFrame_CancelCinematic(); StopCinematic();");
						await Coroutine.Sleep(3000);
					}
				]]>
			</CustomBehavior>
		<!-- END RunCode Methods -->

		<!-- Alliance Section -->
			<If Condition="Me.IsAlliance">
				<If Condition="NeedsQuest(44663)" >
					<If Condition="Unit(114562) == null" >
						<MoveTo Nav="Fly" X="-8866.701" Y="642.0375" Z="96.14512" />
					</If>
					<PickUp QuestName="In the Blink of an Eye" QuestId="44663" GiverName="Khadgar's Upgraded Servant" GiverId="114562" X="-8866.701" Y="642.0375" Z="96.14512" />
				</If>

				<While Condition="DoQuest(44663)" >
					<CustomBehavior File="InteractWith" MobId="216350" QuestId="44663" QuestObjectiveIndex="1" X="-8401.058" Y="330.757" Z="147.0138" />
				</While>
			</If>
		<!-- END Alliance Section -->

		<!-- Horde Section -->
			<If Condition="Me.IsHorde">
				<If Condition="NeedsQuest(44663)" >
					<If Condition="Unit(114562) == null" >
						<MoveTo Nav="Fly" X="1824.579" Y="-4421.238" Z="103.3658" />
					</If>
					<PickUp QuestName="In the Blink of an Eye" QuestId="44663" GiverName="Khadgar's Upgraded Servant" GiverId="114562" X="1824.579" Y="-4421.238" Z="103.3658" />
				</If>

				<While Condition="DoQuest(44663)" >
					<CustomBehavior File="InteractWith" MobId="254292" QuestId="44663" QuestObjectiveIndex="1" X="1758.979" Y="-4293.224" Z="7.621215" />
				</While>
			</If>
		<!-- END Horde Section -->

		<MoveTo QuestId="44663" QuestObjectiveIndex="2" X="-11110.77" Y="-2023.361" Z="747.4564" />
		<CustomBehavior File="InteractWith" MobId="113986" GossipOptions="1" QuestId="44663" QuestObjectiveIndex="2" X="-11112.06" Y="-2024.847" Z="747.4567" />
		<CustomBehavior File="RunCode" Code="await SkipCutscene();" />

		<If Condition="HasQuest(44663)" >
			<TurnIn QuestName="In the Blink of an Eye" QuestId="44663" TurnInName="Emissary Auldbridge" TurnInId="111109" X="-834.3594" Y="4399.119" Z="737.5295" />
		</If>

		<If Condition="HasQuest(44184)" > <!-- Alternative Id if player skipped intro to Draenor. -->
			<TurnIn QuestName="In the Blink of an Eye" QuestId="44184" TurnInName="Emissary Auldbridge" TurnInId="111109" X="XXX" Y="YYY" Z="ZZZ" />
		</If>


		<!-- Load Class Hall stuff -->
			<!--
			NOTE <ImproveLater> : This is currently the easy solution.
			I'm thinking a RunCode where Me.Class auto-fills the text with using ProfileManager.LoadNew to load the profilewould be more clean.
			-->
			<If Condition="Me.Class == WoWClass.Warrior" >
				<CustomBehavior File="LoadProfile" ProfileName="Class Hall Loaders/[N - Quest] Warrior [Echo]" />
			</If>
			<If Condition="Me.Class == WoWClass.Paladin" >
				<CustomBehavior File="LoadProfile" ProfileName="Class Hall Loaders/[N - Quest] Paladin [Echo]" />
			</If>
			<If Condition="Me.Class == WoWClass.Hunter" >
				<CustomBehavior File="LoadProfile" ProfileName="Class Hall Loaders/[N - Quest] Hunter [Echo]" />
			</If>
			<If Condition="Me.Class == WoWClass.Rogue" >
				<CustomBehavior File="LoadProfile" ProfileName="Class Hall Loaders/[N - Quest] Rogue [Echo]" />
			</If>
			<If Condition="Me.Class == WoWClass.Priest" >
				<CustomBehavior File="LoadProfile" ProfileName="Class Hall Loaders/[N - Quest] Priest [Echo]" />
			</If>
			<If Condition="Me.Class == WoWClass.DeathKnight" >
				<CustomBehavior File="LoadProfile" ProfileName="Class Hall Loaders/[N - Quest] Death Knight [Echo]" />
			</If>
			<If Condition="Me.Class == WoWClass.Shaman" >
				<CustomBehavior File="LoadProfile" ProfileName="Class Hall Loaders/[N - Quest] Shaman [Echo]" />
			</If>
			<If Condition="Me.Class == WoWClass.Mage" >
				<CustomBehavior File="LoadProfile" ProfileName="Class Hall Loaders/[N - Quest] Mage [Echo]" />
			</If>
			<If Condition="Me.Class == WoWClass.Warlock" >
				<CustomBehavior File="LoadProfile" ProfileName="Class Hall Loaders/[N - Quest] Warlock [Echo]" />
			</If>
			<If Condition="Me.Class == WoWClass.Monk" >
				<CustomBehavior File="LoadProfile" ProfileName="Class Hall Loaders/[N - Quest] Monk [Echo]" />
			</If>
			<If Condition="Me.Class == WoWClass.Druid" >
				<CustomBehavior File="LoadProfile" ProfileName="Class Hall Loaders/[N - Quest] Druid [Echo]" />
			</If>
			<If Condition="Me.Class == WoWClass.DemonHunter" >
				<CustomBehavior File="LoadProfile" ProfileName="Class Hall Loaders/[N - Quest] Demon Hunter [Echo]" />
			</If>
		<!-- END Load Class Hall stuff -->
		
	</QuestOrder>
</HBProfile>